CREATE TABLE music_service.user_actions
(
    user_id UInt64,
    action_time DateTime,
    action_type Enum8(
        'play' = 1,
        'pause' = 2,
        'skip' = 3,
        'like' = 4,
        'dislike' = 5,
        'share' = 6,
        'download' = 7,
        'add_to_playlist' = 8,
        'remove_from_playlist' = 9,
        'search' = 10
    ),
    track_id String,
    artist_id String,
    album_id String,
    playlist_id Nullable(String),
    search_query Nullable(String),
    duration_seconds Nullable(UInt32),
    position_seconds Nullable(UInt32),
    client_info String,
    ip_address String,
    country LowCardinality(String),
    city LowCardinality(String),
    device_type Enum8('mobile' = 1, 'desktop' = 2, 'tablet' = 3, 'tv' = 4, 'other' = 5),
    os LowCardinality(String),
    app_version LowCardinality(String)
)
ENGINE = MergeTree()
PARTITION BY toYYYYMM(action_time)
ORDER BY (user_id, action_time, action_type);



Популярные треки за последнюю неделю
sql
SELECT 
    track_id,
    count() as play_count
FROM music_service.user_actions
WHERE action_type = 'play' 
  AND action_time >= now() - interval 7 day
GROUP BY track_id
ORDER BY play_count DESC
LIMIT 10;


Среднее время прослушивания по пользователям
SELECT
    user_id,
    avg(duration_seconds) as avg_listening_seconds
FROM music_service.user_actions
WHERE action_type = 'play'
  AND duration_seconds > 0
GROUP BY user_id;


